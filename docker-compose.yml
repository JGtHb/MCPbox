# MCPbox - Self-hosted MCP Server Management Platform
# Hybrid Architecture: Local-first with optional Cloudflare Worker for remote access
#
# ARCHITECTURE:
#   - Admin API (backend:8000): Local-only, serves /api/* endpoints
#   - MCP Gateway (mcp-gateway:8002): Serves /mcp endpoints
#     - Local mode: No auth required (for Claude Desktop)
#     - Remote mode: Validates X-MCPbox-Service-Token from Cloudflare Worker
#   - Cloudflare Tunnel: Optional, connects MCP Gateway to your Worker
#
# REQUIRED environment variables:
#   POSTGRES_PASSWORD - Database password
#   MCPBOX_ENCRYPTION_KEY - 64-char hex key for credential encryption
#   SANDBOX_API_KEY - API key for sandbox authentication
#
# OPTIONAL for remote access:
#   Service token is stored in the database (generated by wizard)
#   Tunnel token is stored in the database (managed via UI/wizard)

services:
  # ============================================================
  # Frontend - React Web UI (Admin Panel - Local Only)
  # ============================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:8000
    ports:
      - "127.0.0.1:${MCPBOX_FRONTEND_PORT:-3000}:3000"
    depends_on:
      - backend
    networks:
      - mcpbox-internal
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/nginx-health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ============================================================
  # Backend - Python FastAPI (Admin API - Local Only)
  # ============================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${MCPBOX_BACKEND_PORT:-8000}:8000"
      - "127.0.0.1:8976:8976"  # Wrangler OAuth callback
    environment:
      - DATABASE_URL=postgresql+asyncpg://mcpbox:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/mcpbox
      - MCPBOX_ENCRYPTION_KEY=${MCPBOX_ENCRYPTION_KEY:?MCPBOX_ENCRYPTION_KEY is required}
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      - SANDBOX_URL=http://sandbox:8001
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-30}
      - BACKEND_URL=${BACKEND_URL:-http://localhost:8000}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./worker/src:/app/worker/src:ro  # Worker source for wrangler deploy
      - ./worker/package.json:/app/worker/package.json:ro  # Worker package.json for npm install
    depends_on:
      postgres:
        condition: service_healthy
      sandbox:
        condition: service_healthy
    networks:
      - mcpbox-internal
      - mcpbox-sandbox
      - mcpbox-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  # ============================================================
  # MCP Gateway - Tunnel-exposed MCP endpoint
  # Validates X-MCPbox-Service-Token using token from database
  # ============================================================
  mcp-gateway:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["python", "-m", "uvicorn", "app.mcp_only:app", "--host", "0.0.0.0", "--port", "8002", "--workers", "2", "--timeout-graceful-shutdown", "30"]
    environment:
      - DATABASE_URL=postgresql+asyncpg://mcpbox:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/mcpbox
      - MCPBOX_ENCRYPTION_KEY=${MCPBOX_ENCRYPTION_KEY:?MCPBOX_ENCRYPTION_KEY is required}
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      - SANDBOX_URL=http://sandbox:8001
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-30}
      - MCP_CORS_ORIGINS=${MCP_CORS_ORIGINS:-https://mcp.claude.ai,https://claude.ai}
    security_opt:
      - no-new-privileges:true
    depends_on:
      postgres:
        condition: service_healthy
      sandbox:
        condition: service_healthy
    networks:
      - mcpbox-internal
      - mcpbox-sandbox
      - mcpbox-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ============================================================
  # Sandbox - Isolated tool execution environment
  # ============================================================
  sandbox:
    build:
      context: ./sandbox
      dockerfile: Dockerfile
    environment:
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      - MCPBOX_ENCRYPTION_KEY=${MCPBOX_ENCRYPTION_KEY:?MCPBOX_ENCRYPTION_KEY is required}
      - BACKEND_URL=http://backend:8000
      - SANDBOX_PACKAGES_DIR=/app/site-packages
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M
    volumes:
      - mcpbox-sandbox-packages:/app/site-packages
    networks:
      - mcpbox-sandbox
      - mcpbox-sandbox-external  # For pip access to PyPI
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ============================================================
  # PostgreSQL - Configuration and State Storage
  # ============================================================
  postgres:
    image: postgres:16.2-alpine
    environment:
      - POSTGRES_USER=mcpbox
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=mcpbox
    volumes:
      - mcpbox-postgres:/var/lib/postgresql/data
    networks:
      - mcpbox-db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcpbox"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ============================================================
  # Cloudflare Tunnel (Optional) - For remote access
  # Points to mcp-gateway:8002
  # Fetches tunnel token from backend database at startup
  # ============================================================
  cloudflared:
    build:
      context: ./cloudflared
      dockerfile: Dockerfile
    environment:
      - BACKEND_URL=http://backend:8000
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
    depends_on:
      backend:
        condition: service_healthy
      mcp-gateway:
        condition: service_healthy
    networks:
      - mcpbox-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

networks:
  mcpbox-internal:
    driver: bridge
    internal: false

  mcpbox-sandbox:
    driver: bridge
    internal: true

  mcpbox-sandbox-external:
    driver: bridge
    internal: false

  mcpbox-db:
    driver: bridge
    internal: true

volumes:
  mcpbox-postgres:
    driver: local
  mcpbox-sandbox-packages:
    driver: local
