# MCPbox - Self-hosted MCP Server Management Platform
# Hybrid Architecture: Local-first with optional Cloudflare Worker for remote access
#
# ARCHITECTURE:
#   - Admin API (backend:8000): Local-only, serves /api/* endpoints
#   - MCP Gateway (mcp-gateway:8002): Serves /mcp endpoints
#     - Local mode: No auth required (for Claude Desktop)
#     - Remote mode: Validates X-MCPbox-Service-Token from Cloudflare Worker
#   - Cloudflare Tunnel: Optional, connects MCP Gateway to your Worker
#
# REQUIRED environment variables:
#   POSTGRES_PASSWORD - Database password
#   MCPBOX_ENCRYPTION_KEY - 64-char hex key for credential encryption
#   SANDBOX_API_KEY - API key for sandbox authentication
#
# OPTIONAL for remote access:
#   Service token is stored in the database (generated by wizard)
#   Tunnel token is stored in the database (managed via UI/wizard)

services:
  # ============================================================
  # Frontend - React Web UI (Admin Panel - Local Only)
  # ============================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${MCPBOX_FRONTEND_PORT:-3000}:3000"
    environment:
      - MCPBOX_ENABLE_HSTS=${MCPBOX_ENABLE_HSTS:-false}
    depends_on:
      - backend
    networks:
      - mcpbox-internal
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=16M,uid=1000,gid=1000
      - /var/cache/nginx:size=32M,uid=1000,gid=1000
      - /var/run:size=1M,uid=1000,gid=1000
      - /etc/nginx/conf.d:size=1M,uid=1000,gid=1000
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/nginx-health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
          pids: 64

  # ============================================================
  # Backend - Python FastAPI (Admin API, accessed via frontend nginx proxy)
  # ============================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "127.0.0.1:${MCPBOX_BACKEND_PORT:-8000}:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://mcpbox:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/mcpbox
      - MCPBOX_ENCRYPTION_KEY=${MCPBOX_ENCRYPTION_KEY:?MCPBOX_ENCRYPTION_KEY is required}
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      - SANDBOX_URL=http://sandbox:8001
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      - CLOUDFLARED_API_KEY=${CLOUDFLARED_API_KEY:-}
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=256M
      - /home/mcpbox/.cache:size=32M
    depends_on:
      postgres:
        condition: service_healthy
      sandbox:
        condition: service_healthy
    networks:
      - mcpbox-internal
      - mcpbox-sandbox
      - mcpbox-db
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
          pids: 256

  # ============================================================
  # MCP Gateway - Tunnel-exposed MCP endpoint
  # Validates X-MCPbox-Service-Token using token from database
  # ============================================================
  mcp-gateway:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: ["python", "-m", "uvicorn", "app.mcp_only:app", "--host", "0.0.0.0", "--port", "8002", "--workers", "1", "--timeout-graceful-shutdown", "30"]
    environment:
      - DATABASE_URL=postgresql+asyncpg://mcpbox:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/mcpbox
      - MCPBOX_ENCRYPTION_KEY=${MCPBOX_ENCRYPTION_KEY:?MCPBOX_ENCRYPTION_KEY is required}
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      - SANDBOX_URL=http://sandbox:8001
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MCP_CORS_ORIGINS=${MCP_CORS_ORIGINS:-https://mcp.claude.ai,https://claude.ai,https://chatgpt.com,https://chat.openai.com,https://platform.openai.com}
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M
    depends_on:
      postgres:
        condition: service_healthy
      sandbox:
        condition: service_healthy
    networks:
      - mcpbox-internal
      - mcpbox-sandbox
      - mcpbox-db
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
          pids: 128

  # ============================================================
  # Sandbox - Isolated tool execution environment
  # ============================================================
  sandbox:
    build:
      context: ./sandbox
      dockerfile: Dockerfile
    environment:
      - SANDBOX_API_KEY=${SANDBOX_API_KEY:?SANDBOX_API_KEY is required}
      # SECURITY (F-03): MCPBOX_ENCRYPTION_KEY intentionally excluded from sandbox.
      # The sandbox doesn't need it, and exposing it increases blast radius on escape.
      - BACKEND_URL=http://backend:8000
      - SANDBOX_PACKAGES_DIR=/app/site-packages
      # SECURITY: All outbound traffic forced through squid proxy.
      # Sandbox has no direct internet access (not on mcpbox-sandbox-external).
      - HTTPS_PROXY=http://squid-proxy:3128
      - HTTP_PROXY=http://squid-proxy:3128
      # Exclude internal service communication from proxy
      - NO_PROXY=backend,localhost,127.0.0.1
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M
    volumes:
      - mcpbox-sandbox-packages:/app/site-packages
      - mcpbox-squid-acl:/shared/squid-acl        # Approved private hosts → squid ACL helper
    depends_on:
      squid-proxy:
        condition: service_healthy
    networks:
      - mcpbox-sandbox
      - mcpbox-sandbox-proxy   # ALL outbound traffic → squid proxy (no direct internet)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
          pids: 128

  # ============================================================
  # Squid Proxy - Egress filter for sandbox
  # All sandbox outbound traffic forced through this proxy.
  # Blocks private IPs; per-server domain filtering at app layer.
  # ============================================================
  squid-proxy:
    build:
      context: ./squid-proxy
      dockerfile: Dockerfile
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/spool/squid:size=16M,uid=31,gid=31
      - /var/log/squid:size=8M,uid=31,gid=31
      - /var/run/squid:size=1M,uid=31,gid=31
      - /tmp:size=1M
    volumes:
      - mcpbox-squid-acl:/shared/squid-acl:ro   # Read approved private hosts from sandbox
    networks:
      - mcpbox-sandbox-proxy     # Receives sandbox traffic
      - mcpbox-sandbox-external  # Outbound to internet
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/run/squid/squid.pid && kill -0 $(cat /var/run/squid/squid.pid)"]
      interval: 30s
      timeout: 5s
      start_period: 5s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
          pids: 32

  # ============================================================
  # PostgreSQL - Configuration and State Storage
  # ============================================================
  postgres:
    image: postgres:16.2-alpine
    environment:
      - POSTGRES_USER=mcpbox
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=mcpbox
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
    volumes:
      - mcpbox-postgres:/var/lib/postgresql/data
    networks:
      - mcpbox-db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcpbox"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
          pids: 128

  # ============================================================
  # Cloudflare Tunnel (Optional) - For remote access
  # Points to mcp-gateway:8002
  # Fetches tunnel token from backend database at startup
  # ============================================================
  cloudflared:
    build:
      context: ./cloudflared
      dockerfile: Dockerfile
    environment:
      - BACKEND_URL=http://backend:8000
      # Dedicated key for cloudflared (falls back to SANDBOX_API_KEY if not set)
      - CLOUDFLARED_API_KEY=${CLOUDFLARED_API_KEY:-${SANDBOX_API_KEY}}
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=16M
    depends_on:
      backend:
        condition: service_healthy
      mcp-gateway:
        condition: service_healthy
    networks:
      - mcpbox-internal
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:2000/ready"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
          pids: 32

networks:
  mcpbox-internal:
    driver: bridge
    internal: false

  mcpbox-sandbox:
    driver: bridge
    internal: true

  mcpbox-sandbox-proxy:
    driver: bridge
    internal: true  # Sandbox ↔ squid proxy (sandbox has no direct internet)

  mcpbox-sandbox-external:
    driver: bridge
    internal: false  # Squid-only outbound (sandbox is NOT on this network)

  mcpbox-db:
    driver: bridge
    internal: true

volumes:
  mcpbox-postgres:
    driver: local
  mcpbox-sandbox-packages:
    driver: local
  mcpbox-squid-acl:
    driver: local
