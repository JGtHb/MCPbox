# MCPbox Squid Proxy — egress filter for sandbox
#
# All sandbox outbound traffic is forced through this proxy via Docker
# network isolation (sandbox has no direct internet access).
#
# Policy:
#   - HTTPS CONNECT on port 443 only (no plain HTTP egress)
#   - Private/internal IPs blocked (squid resolves DNS and checks dst)
#   - Per-server domain enforcement handled by SSRF client (application layer)

# --- Port ---
http_port 3128

# --- ACL definitions ---
# Minimal ACLs (squid 7 requires 'all' instead of '0.0.0.0/0')
acl localnet src all
acl SSL_ports port 443
acl CONNECT method CONNECT

# Block private/internal IP ranges at the proxy level.
# Squid resolves DNS for CONNECT requests and checks the resolved IP
# against these ACLs before establishing the tunnel.
acl blocked_dst dst 0.0.0.0/8          # "This network" (RFC 1122)
acl blocked_dst dst 10.0.0.0/8         # Private Class A
acl blocked_dst dst 100.64.0.0/10      # Shared address space (RFC 6598)
acl blocked_dst dst 127.0.0.0/8        # Loopback
acl blocked_dst dst 169.254.0.0/16     # Link-local / cloud metadata
acl blocked_dst dst 172.16.0.0/12      # Private Class B
acl blocked_dst dst 192.168.0.0/16     # Private Class C
acl blocked_dst dst fc00::/7            # IPv6 unique local
acl blocked_dst dst fe80::/10           # IPv6 link-local
acl blocked_dst dst ::1/128            # IPv6 loopback

# --- Admin-approved private hosts (dynamic) ---
# External ACL helper checks a file maintained by the sandbox registry.
# Hosts approved via the network-access-request flow are written to
# /shared/squid-acl/approved-private.txt (shared Docker volume).
# TTL=5s means newly approved hosts take ≤5 seconds to propagate.
external_acl_type approved_private_dst ttl=5 negative_ttl=5 children-max=2 concurrency=0 %DST /usr/local/bin/check-approved-private.sh
acl approved_private external approved_private_dst

# --- Access rules (order matters) ---
# 1. Allow traffic to admin-approved private hosts (before deny)
http_access allow approved_private

# 2. Block all other traffic to private/internal IPs
http_access deny blocked_dst

# 3. Allow HTTPS CONNECT tunnels on port 443
http_access allow CONNECT SSL_ports

# 4. Deny everything else (plain HTTP, non-443 CONNECT, etc.)
http_access deny all

# --- Caching ---
cache deny all  # Filtering proxy only, no caching

# PID file location (must be in a writable tmpfs under read_only containers)
pid_filename /var/run/squid/squid.pid

# --- Logging ---
access_log stdio:/dev/stdout
cache_log stdio:/dev/stderr

# --- Security hardening ---
via off                          # Don't reveal proxy chain
forwarded_for delete             # Strip client IP from headers
httpd_suppress_version_string on # Hide squid version string

# --- Resource limits ---
cache_mem 8 MB
maximum_object_size 0 KB
